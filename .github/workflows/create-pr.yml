name: Create a PR
env:
  RUN_IN_DEBUG: ${{ secrets.ACTIONS_STEP_DEBUG || 'false' }}

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Target platform for the PR (android or ios)'
        required: true
        default: 'android'
      kmp_tag:
        description: 'The KMP tag to pull from'
        required: true
        default: 'v1.97.3'

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-text:
    name: Update text file
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.commit_push.outputs.token }}
    steps:
      - name: Generate a token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID_GITHUB }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-actions: write
          permission-pull-requests: write
          permission-workflows: write
          permission-contents: write
          owner: ${{ github.repository_owner }}
          repositories: "${{ github.repository }}"
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: '${{ steps.generate_token.outputs.token }}'
      - name: Update text file
        run: |
          echo "Updating text file with KMP tag: ${{ github.event.inputs.kmp_tag }}"
          echo "KMP Tag: ${{ github.event.inputs.kmp_tag }}" > kmp_tag.txt
      - name: Commit and push changes
        id: commit_push
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add kmp_tag.txt
          git checkout -b update-kmp-tag
          git commit -m "Update KMP tag to ${{ github.event.inputs.kmp_tag }}"
          git push origin update-kmp-tag
          echo "token=${{ steps.generate_token.outputs.token }}" >> $GITHUB_OUTPUT

  create-pr:
    name: Create Pull Request
    needs: update-text
    env:
      TOTO: ${{ steps.update-text.outputs.token }}
    runs-on: ubuntu-latest
    steps:
      - name: 'üïµÔ∏è‚Äç‚ôÇÔ∏è Start SSH session for debugging'
        if: ${{ env.RUN_IN_DEBUG == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          limit-access-to-actor: true
          connect-timeout-seconds: 180
      - name: Generate a token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID_GITHUB }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-actions: write
          permission-pull-requests: write
          permission-workflows: write
          permission-contents: write
          owner: ${{ github.repository_owner }}
          repositories: "${{ github.repository }}"
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: update-kmp-tag
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh pr create --title "Update KMP tag to ${{ github.event.inputs.kmp_tag }}" \
            --body "This PR updates the KMP tag to ${{ github.event.inputs.kmp_tag }} for the ${{ github.event.inputs.platform }} platform." \ 
            --reviewer ${{ github.actor }} \
            --assignee ${{ github.actor }} \
            --draft
